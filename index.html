<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>HTML5 - WebGL - Normal Mapping</title>

    <link rel="stylesheet" href="css/main.css" media="screen">
</head>

<body>
    <script id="default_vsh" type="x-shader/x-vertex">
        uniform mat4 u_mv;
        uniform mat4 u_mvp;

        attribute vec3 a_vertex;
        attribute vec2 a_textCoord;

        varying vec2 v_texturePosition;
        varying vec4 v_position;

        void main()
        {
            v_texturePosition = a_textCoord;

            v_position = u_mv * vec4(a_vertex, 1.0);
            gl_Position = u_mvp * vec4(a_vertex, 1.0);
        }
	</script>
	<script id="default_fsh" type="x-shader/x-fragment">
        precision highp float;

        uniform sampler2D u_texture;
        uniform sampler2D u_map;

        uniform vec2 u_pos;

        varying vec2 v_texturePosition;
        varying vec4 v_position;

        void main()
        {
            vec3 lightPosition = vec3(u_pos, 64.0);
            vec4 lightColor = vec4(0.0, 0.0, 0.0, 1.0);
            vec4 diffuseColor = vec4(227.0/255.0, 190.0/255.0, 127.0/255.0, 1.0);
            float lightPower = 10000.0;


            vec4 textureColor = texture2D(u_texture, v_texturePosition);
            vec4 mapColor = texture2D(u_map, v_texturePosition);

            vec3 normal = mapColor.xyz * 2.0 - vec3(1.0, 1.0, 1.0);

            float dist = distance(v_position.xyz, lightPosition);
            vec3 lightDirection = normalize(lightPosition - v_position.xyz);

            float f = clamp(dot(normal, lightDirection), 0.0, 1.0);
            vec3 r = reflect(-lightDirection, normal);
            float fcos = clamp(dot(vec3(0.0, 0.0, 1.0), r), 0.0, 1.0);

            vec4 ambient = textureColor * lightColor;
            vec4 diffuse = textureColor * diffuseColor * f * lightPower / dist / dist;
            vec4 specular = textureColor * diffuseColor * pow(fcos, 16.0) / dist / dist;

            gl_FragColor = ambient + diffuse + specular;
        }
	</script>

    <canvas id="canvasElement" width="480" height="480"></canvas>

    <div class="image-cache">
        <img id="tile" src="resources/tile.png" />
		<img id="ntile" src="resources/ntile.png" />

		<!-- <img id="death" src="resources/death.png" />
		<img id="vader" src="resources/vader.png" />
		<img id="levi" src="resources/levi.png" /> -->
    </div>

    <!-- <script src="js/lodash.core.js" async></script> -->
    <script src="js/tools.js" async></script>
    <script src="js/buffer.js" async></script>
    <script src="js/shader.js" async></script>
    <script src="js/texture.js" async></script>
    <script src="js/math.js" async></script>
    <script src="js/core.js" async></script>
    <script src="js/main.js" async></script>
</body>

</html>
